<!doctype html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <title>Experiment: Focus</title>
  <script type="text/javascript">
    const list1 = [
      "<span style='color: white;'>A.</span> 佢做咗啲咩？佢擺咗本書喺張枱上面。",
      "<span style='color: white;'>B.</span> 佢擺咗<span style='background-color:#FFCC00;'>啲咩</span>喺張枱上面呀？佢擺咗<span style='background-color:#FFCC00;'>本書</span>喺張枱上面。",
      "<span style='color: white;'>C.</span> 佢擺咗本書喺張<span style='background-color:#FFCC00;'>櫈</span>上面呀？唔係啊，佢擺咗本書喺張<span style='background-color:#FFCC00;'>枱</span>上面。",
      "<span style='color: white;'>D.</span> <span style='background-color:#FFCC00;'>你</span>擺咗本書喺張枱上面呀？ 唔係啊，<span style='background-color:#FFCC00;'>佢</span>擺咗本書喺張枱上面。"
    ];

    const list2 = [
      "<span style='color: white;'>A.</span> 你話乜嘢？嗰個嘉賓拎膠樽。",
      "<span style='color: white;'>B.</span> 邊個拎膠樽？<span style='background-color:#FFCC00;'>嗰個嘉賓</span>拎膠樽。",
      "<span style='color: white;'>C.</span> 嗰個嘉賓乜嘢膠樽？嗰個嘉賓<span style='background-color:#FFCC00;'>拎</span>膠樽。",
      "<span style='color: white;'>D.</span> 嗰個嘉賓拎乜嘢？嗰個嘉賓拎<span style='background-color:#FFCC00;'>膠樽</span>。"
    ];

    const REST_TEXT = "You may now take a break";
    const nRepetitions = 4;
    const batchSize = 40;
    let displayList = [];
    let itemsAdded = 0;
    let subjectname = "";
    let experimentdate = "";

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function generateSentenceList() {
      displayList = [];
      itemsAdded = 0;

      // First, add all repetitions of list1
      for (let i = 0; i < nRepetitions; i++) {
        let shuffled1 = shuffle(list1.slice());
        
        for (let j = 0; j < shuffled1.length; j++) {
          if (j === 0 || shuffled1[j] !== shuffled1[j - 1]) {
            displayList.push(shuffled1[j]);
            itemsAdded++;
          }
          if (itemsAdded % batchSize === 0) {
            displayList.push(REST_TEXT);
          }
        }
        displayList.push(`<span style='color: grey; font-size: 1rem;'>end of sentence set ${i + 1} (List 1)</span>`);
      }

      // Then, add all repetitions of list2
      for (let i = 0; i < nRepetitions; i++) {
        let shuffled2 = shuffle(list2.slice());
        
        for (let j = 0; j < shuffled2.length; j++) {
          if (j === 0 || shuffled2[j] !== shuffled2[j - 1]) {
            displayList.push(shuffled2[j]);
            itemsAdded++;
          }
          if (itemsAdded % batchSize === 0) {
            displayList.push(REST_TEXT);
          }
        }
        displayList.push(`<span style='color: grey; font-size: 1rem;'>end of sentence set ${i + 1} (List 2)</span>`);
      }
    }

    function generateFileContent() {
      let content = `Subject Name: ${subjectname}\nDate of experiment: ${experimentdate}\n\nTrial\tSentence\n`;
      let k = 0;
      let addedList1Header = false;
      let addedList2Header = false;
      
      for (let i = 0; i < displayList.length; i++) {
        if (displayList[i] === REST_TEXT) {
          content += `\t${REST_TEXT}\n`;
        } else if (isSentence(displayList[i])) {
          // Check if this is a List 2 sentence by looking for the second set sentences
          const isList2Sentence = list2.some(sentence => {
            const cleanSentence = sentence.replace(/<[^>]*>?/gm, '');
            const cleanDisplay = displayList[i].replace(/<[^>]*>?/gm, '');
            return cleanDisplay === cleanSentence;
          });
          
          // Add appropriate list header
          if (!isList2Sentence && !addedList1Header) {
            content += `List 1\n`;
            addedList1Header = true;
          } else if (isList2Sentence && !addedList2Header) {
            content += `List 2\n`;
            addedList2Header = true;
          }
          
          k++;
          const textOnly = displayList[i].replace(/<[^>]*>?/gm, ''); // remove HTML tags
          content += `${k}\t${textOnly}\n`;
        }
      }
      return content;
    }

    function downloadResults() {
      const fileContent = generateFileContent();
      const blob = new Blob([fileContent], {type: "text/plain;charset=utf-8"});
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `ZH-YT-sentence-list-${subjectname}-${experimentdate}.txt`;
      link.click();
    }

    function initializeExperiment() {
      subjectname = prompt("Name", "");
      experimentdate = prompt("Date of experiment (dd/mm/yy)", "");
      
      // Check if user cancelled or entered empty values
      if (subjectname === null || experimentdate === null || 
          subjectname.trim() === "" || experimentdate.trim() === "") {
        alert("Name and date are required to start the experiment.");
        return;
      }

      // Generate the sentence list
      generateSentenceList();
      
      // Automatically download the sentence file
      downloadResults();
      
      // Show a confirmation message
      alert("Sentence file has been downloaded. You can now begin the experiment.");
      
      // Initialize the experiment display
      thisPic = -1;
      trialCount = 0;
      updateDisplay();
      
      // Show the experiment interface
      document.getElementById("experimentInterface").style.display = "block";
      document.getElementById("startButton").style.display = "none";
    }

    let thisPic = -1;
    let trialCount = 0;

    function isSentence(content) {
      return content !== REST_TEXT && !content.includes("end of sentence set");
    }

    function updateDisplay() {
      if (thisPic >= 0 && thisPic < displayList.length) {
        const content = displayList[thisPic];
        document.getElementById("display").innerHTML = content;

        if (content === REST_TEXT) {
          document.getElementById("trialNumber").innerText = "Break";
        } else {
          document.getElementById("trialNumber").innerText = "";
        }
      } else if (thisPic >= displayList.length) {
        document.getElementById("display").innerHTML = "End of experiment. Thanks for your participation";
        document.getElementById("trialNumber").innerText = "";
        document.getElementById("nextBtn").style.display = "none"; // hide Next Sentence
      }

      // Hide Previous button on first page (thisPic < 0)
      if (thisPic < 0) {
        document.getElementById("prevBtn").style.display = "none";
      } else {
        document.getElementById("prevBtn").style.display = "inline-block";
      }
    }

    function processPrevious() {
      if (thisPic > 0) {
        thisPic--;
        if (isSentence(displayList[thisPic])) {
          trialCount--;
        }
        // Show the Next button again if we're not at the end
        if (thisPic < displayList.length) {
          document.getElementById("nextBtn").style.display = "inline-block";
        }
        updateDisplay();
      }
    }

    function processNext() {
      if (thisPic < displayList.length - 1) {
        thisPic++;
        if (isSentence(displayList[thisPic])) {
          trialCount++;
        }
        updateDisplay();
      } else {
        thisPic = displayList.length;
        updateDisplay();
      }
    }

    window.onload = function() {
      document.getElementById("repetitionCount").innerText = nRepetitions;
      document.getElementById("repetitionCount2").innerText = nRepetitions;
    };
  </script>
</head>

<body>
  <div class="container" style="max-width: 1100px; margin: 0 auto; padding: 20px; text-align: center; font-family: 'Segoe UI';">
    <h2>Instructions</h2>
    <h3 id="instructions" style="font-weight: normal; line-height: 1.6;">
      Below, you will see a question and an answer in the textbox.<br>
      Please say aloud both the question and the sentence as if you are acting as two speakers talking with each other.<br>
      Pay attention to emphasize the right word when saying the answers.<br>
      在下面的框里，你会看到一个问题和一个回答。<br>
      请把问题和回答都大声读出来，就像两个人在聊天一样。<br>
      读回答的时候，记得把重点词说得更清楚。<br>
    </h3>

    <button id="startButton" onclick="initializeExperiment()" style="padding: 15px 30px; font-size: 1.2rem; background-color: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 20px;">
      Start Experiment / 开始实验
    </button>

    <div id="experimentInterface" style="display: none;">
      <div id="display" style="width: 100%; min-height: 100px; font-size: 2rem; padding: 10px; border: 1px solid #ccc; text-align: left;"></div>
      <p id="trialNumber" style="font-size: 1.2rem; margin-top: 10px;"></p>

      <div class="buttons" style="margin-top: 30px; display: flex; justify-content: center; gap: 20px;">
        <a id="prevBtn" href="javascript:processPrevious()" style="text-decoration: none; padding: 10px 20px; font-size: 1rem; background-color: #007bff; color: white; border-radius: 6px;">&laquo; 上一句 | Previous Sentence</a>
        <a id="nextBtn" href="javascript:processNext()" style="text-decoration: none; padding: 10px 20px; font-size: 1rem; background-color: #007bff; color: white; border-radius: 6px;">下一句 | Next Sentence &raquo;</a>
      </div>
    </div>
  </div>
</body>
</html>
